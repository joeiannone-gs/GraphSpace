#!/bin/bash


sudo dnf update -y

sudo dnf install -y python3.12 git nodejs npm protobuf-compiler nginx
python3.12 -m ensurepip

cat <<'EOF' > /home/ec2-user/openssl-ip.cnf
[req]
default_bits = 4096
default_md = sha256
distinguished_name = req_distinguished_name
x509_extensions = v3_req
prompt = no

[req_distinguished_name]
C = US
ST = State
L = City
O = GraphSpace
OU = GraphSpace
CN = 54.187.246.153

[v3_req]
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
IP.1 = 54.187.246.153
EOF

sudo openssl req -new -nodes -x509 -days 365   -keyout /etc/ssl/nginx-selfsigned.key   -out /etc/ssl/certs/nginx-selfsigned.crt   -config /home/ec2-user/openssl-ip.cnf


cat <<'EOF' | sudo tee /etc/nginx/nginx.conf

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {

     map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name _;

        ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
        ssl_certificate_key /etc/ssl/nginx-selfsigned.key;

        # Frontend application
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # FastAPI with both HTTP API and WebSocket endpoints
        location /api/ {
            proxy_pass http://127.0.0.1:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Essential timeouts for WebSocket connections
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_connect_timeout 86400;
        }
    }
}

EOF

sudo systemctl restart nginx

git clone https://joeiannone-gs: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@github.com/joeiannone-gs/GraphSpace.git

cd GraphSpace && pip3.12 install -r requirements.txt
python3.12 computeserver/server/database/create_database.py
mkdir -p computeserver/server/protos
protoc --proto_path=shared/protos --python_out=computeserver/server/protos project.proto graph.proto nested_array_store.proto wrapper.proto deltas.proto value.proto path.proto node.proto edge.proto 
protol --create-package --in-place --python-out computeserver/server/protos protoc --proto-path=shared/protos project.proto graph.proto nested_array_store.proto wrapper.proto deltas.proto value.proto path.proto node.proto edge.proto 
python3.12 -m computeserver.main &


cd frontend
npm install
sudo npm install -g protobufjs-cli
pbjs -t static-module -p ../shared/protos -w commonjs -o app/proto/compiled.js path.proto edge.proto value.proto project.proto deltas.proto graph.proto nested_array_store.proto wrapper.proto node.proto 
pbts -o app/proto/compiled.d.ts app/proto/compiled.js
npm run dev